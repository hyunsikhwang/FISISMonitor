name: FISIS Monitor

on:
  schedule:
    - cron: '0 * * * *'  # 매시간 0분에 실행
  workflow_dispatch:  # 수동 실행도 가능

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run FISIS monitor
      env:
        FISIS_API_KEY: ${{ secrets.FISIS_API_KEY }}
      run: |
        python main.py

    - name: Check in and Keep Alive
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # 데이터 업데이트가 없더라도 저장소를 활성 상태로 유지하기 위해
        # keep_alive.txt 파일에 실행 시간을 기록하여 커밋합니다.
        # 이는 GitHub Action이 60일 동안 활동이 없을 경우 자동으로 비활성화되는 것을 방지합니다.
        echo "Last run: $(date)" > keep_alive.txt

        # last_month.txt가 존재할 경우에만 add
        if [ -f "last_month.txt" ]; then
          git add last_month.txt
        fi
        git add keep_alive.txt

        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Monitor run: $(date) [skip ci]"
          git push
        fi

    - name: Manual Keep Alive (Process)
      # 사용자가 명시적으로 요구한 "실행 중 sleep 방지"를 위해
      # 백그라운드 프로세스를 실행하는 로직을 유지합니다 (필요 시).
      # 단, 불필요하게 긴 sleep은 지양하고 짧게 유지합니다.
      run: |
        python main.py keep-alive
